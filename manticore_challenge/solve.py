from manticore import Manticore
from pwn       import log


FILE  = "./manticore_challenge"
DEBUG = True


def set_hooks(m, pc):
    neg = pc + 0x5
    @m.hook(neg)
    def hook_exit(state):
        if DEBUG: log.info("Negative branch @ {0}".format(hex(neg)))
        state.abandon()


def mantify(m):
    @m.hook(0x555555554aba)
    def hook_skip_IO(state):
        pc = state.cpu.PC
        addr = state.cpu.RBP-0x14
        buff = state.new_symbolic_buffer(11)

        if DEBUG: 
            log.info("Skipping IO to speed up the process, jumping from {0} to {1}".format(hex(pc), hex(pc+0x1D)))
            log.info("Writing symbolic buffer @ {0}".format(hex(addr)))

        state.cpu.write_register("RIP", pc+0x1D)
        state.cpu.write_bytes(addr, buff)
        with m.locked_context() as context:
            context["buffer_addr"] = addr

    @m.hook(None)
    def hook_instruction(state):
        cpu    = state.cpu
        pc     = cpu.PC
        opcode = cpu.read_int(pc, size=32)

        with m.locked_context() as context:
            if ((opcode & 0xFFFF == 0xfb80) and
                (opcode >> 24 & 0xFF == 0x74) and
                (pc not in context["branches"])):

                if DEBUG: log.info("Found branch @ {0}".format(hex(pc)))
                _branches = context["branches"]
                _branches.append(pc)
                context["branches"] = _branches
                set_hooks(m, pc)

    @m.hook(0x555555554a95)
    def hook_win(state):
        if DEBUG: log.info("Reached end, solving...")
        with m.locked_context() as context:
            buff = state.cpu.read_bytes(context["buffer_addr"], 11)
            flag = "".join(chr(state.solve_one(x)) for x in buff)
            log.success("Flag is: {0}".format(flag))
        m.terminate()


if __name__ == "__main__":
    m = Manticore(FILE)

    m.context["neg_branches"] = []
    m.context["branches"]     = []
    m.context["buffer_addr"]  = [] 
    
    mantify(m)
    m.run()
